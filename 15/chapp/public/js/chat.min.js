if(!Function.prototype.bind){(function(){var a=Array.prototype.slice;Function.prototype.bind=function(d){var c=this;if(arguments.length>1){var b=a.call(arguments,1);return function(){var e=b;if(arguments.length>0){e=b.concat(a.call(arguments))}return c.apply(d,e)}}return function(){if(arguments.length>0){return c.apply(d,arguments)}return c.call(d)}}}())}if(!Object.create){(function(){function a(){}Object.create=function(b){a.prototype=b;return new a()}}())}var tddjs=(function(){function a(d){var c=this;var f=d.split(".");for(var e=0,b=f.length;e<b;e++){if(typeof c[f[e]]=="undefined"){c[f[e]]={}}c=c[f[e]]}return c}return{namespace:a}}());tddjs.uid=(function(){var b=0;function a(c){if(typeof c.__uid!="number"){c.__uid=b++}return c.__uid}return a}());tddjs.iterator=(function(){function a(e){var b=0;var d=e.length;function c(){var f=e[b++];c.hasNext=b<d;return f}c.hasNext=b<d;return c}return a}());tddjs.isOwnProperty=(function(){var a=Object.prototype.hasOwnProperty;if(typeof a=="function"){return function(b,c){return a.call(b,c)}}else{}}());tddjs.each=(function(){function b(f,j){var k=j.length;for(var h=0;h<k;h++){f[j[h]]=true}var g=k;for(var l in f){if(tddjs.isOwnProperty(f,l)){g-=1;f[l]=false}}if(!g){return}var e=[];for(h=0;h<k;h++){if(f[j[h]]){e.push(j[h])}}return e}var d=b({},["toString","toLocaleString","valueOf","hasOwnProperty","isPrototypeOf","constructor","propertyIsEnumerable"]);var c=b(function(){},["call","apply","prototype"]);if(c&&d){c=d.concat(c)}var a={object:d,"function":c};return function(g,m){if(typeof m!="function"){throw new TypeError("callback is not a function")}for(var k in g){if(tddjs.isOwnProperty(g,k)){m(k,g[k])}}var f=a[typeof g];if(f){var j;for(var h=0,e=f.length;h<e;h++){j=f[h];if(tddjs.isOwnProperty(g,j)){m(j,g[j])}}}}}());tddjs.extend=(function(){function a(c,b){c=c||{};if(!b){return c}tddjs.each(b,function(e,d){c[e]=d});return c}return a}());tddjs.isHostMethod=(function(){function a(b,d){var c=typeof b[d];return c=="function"||(c=="object"&&!!b[d])||c=="unknown"}return a}());tddjs.isEventSupported=(function(){var b={select:"input",change:"input",submit:"form",reset:"form",error:"img",load:"img",abort:"img"};function a(c){var e=b[c];var f=document.createElement(e||"div");c="on"+c;var d=(c in f);if(!d){f.setAttribute(c,"return;");d=typeof f[c]=="function"}f=null;return d}return a}());tddjs.isCSSPropertySupported=(function(){var a=document.createElement("div");function b(c){return typeof a.style[c]=="string"}return b}());(function(){var e=tddjs.namespace("dom");var f;if(!Function.prototype.call){return}function a(g){g.preventDefault=function(){g.returnValue=false};g.target=g.srcElement;return g}if(tddjs.isHostMethod(document,"addEventListener")){f=function(g,h,i){g.addEventListener(h,i,false)}}else{if(tddjs.isHostMethod(document,"attachEvent")){f=function(g,h,i){g.attachEvent("on"+h,function(){var j=a(window.event);i.call(g,j);return j.returnValue})}}else{return}}function c(g,h){var i=null;f(g,"mouseover",function(j){if(i!==g){i=g;h.call(g,j)}});f(g,"mouseout",function(k){var j=k.relatedTarget||k.toElement;try{if(j&&!j.nodeName){j=j.parentNode}}catch(l){return}if(g!==j&&!e.contains(g,j)){i=null}})}var d=e.customEvents={};if(!tddjs.isEventSupported("mouseenter")&&tddjs.isEventSupported("mouseover")&&tddjs.isEventSupported("mouseout")){d.mouseenter=c}e.supportsEvent=function(g){return tddjs.isEventSupported(g)||!!d[g]};function b(g,h,i){if(e.customEvents&&e.customEvents[h]){return e.customEvents[h](g,i)}return f(g,h,i)}e.addEventHandler=b}());tddjs.namespace("util");(function(){function d(f,e){if(!f.observers){f.observers={}}if(!f.observers[e]){f.observers[e]=[]}return f.observers[e]}function c(f,e){if(typeof e!="function"){throw new TypeError("observer is not function")}d(this,f).push(e)}function b(h,f){var j=d(this,h);for(var g=0,e=j.length;g<e;g++){if(j[g]==f){return true}}return false}function a(j){var m=d(this,j);var g=Array.prototype.slice.call(arguments,1);for(var h=0,f=m.length;h<f;h++){try{m[h].apply(this,g)}catch(k){}}}tddjs.namespace("util").observable={observe:c,hasObserver:b,notify:a}}());if(!this.JSON){this.JSON={}}(function(){function f(n){return n<10?"0"+n:n}if(typeof Date.prototype.toJSON!=="function"){Date.prototype.toJSON=function(key){return isFinite(this.valueOf())?this.getUTCFullYear()+"-"+f(this.getUTCMonth()+1)+"-"+f(this.getUTCDate())+"T"+f(this.getUTCHours())+":"+f(this.getUTCMinutes())+":"+f(this.getUTCSeconds())+"Z":null};String.prototype.toJSON=Number.prototype.toJSON=Boolean.prototype.toJSON=function(key){return this.valueOf()}}var cx=/[\u0000\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g,escapable=/[\\\"\x00-\x1f\x7f-\x9f\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g,gap,indent,meta={"\b":"\\b","\t":"\\t","\n":"\\n","\f":"\\f","\r":"\\r",'"':'\\"',"\\":"\\\\"},rep;function quote(string){escapable.lastIndex=0;return escapable.test(string)?'"'+string.replace(escapable,function(a){var c=meta[a];return typeof c==="string"?c:"\\u"+("0000"+a.charCodeAt(0).toString(16)).slice(-4)})+'"':'"'+string+'"'}function str(key,holder){var i,k,v,length,mind=gap,partial,value=holder[key];if(value&&typeof value==="object"&&typeof value.toJSON==="function"){value=value.toJSON(key)}if(typeof rep==="function"){value=rep.call(holder,key,value)}switch(typeof value){case"string":return quote(value);case"number":return isFinite(value)?String(value):"null";case"boolean":case"null":return String(value);case"object":if(!value){return"null"}gap+=indent;partial=[];if(Object.prototype.toString.apply(value)==="[object Array]"){length=value.length;for(i=0;i<length;i+=1){partial[i]=str(i,value)||"null"}v=partial.length===0?"[]":gap?"[\n"+gap+partial.join(",\n"+gap)+"\n"+mind+"]":"["+partial.join(",")+"]";gap=mind;return v}if(rep&&typeof rep==="object"){length=rep.length;for(i=0;i<length;i+=1){k=rep[i];if(typeof k==="string"){v=str(k,value);if(v){partial.push(quote(k)+(gap?": ":":")+v)}}}}else{for(k in value){if(Object.hasOwnProperty.call(value,k)){v=str(k,value);if(v){partial.push(quote(k)+(gap?": ":":")+v)}}}}v=partial.length===0?"{}":gap?"{\n"+gap+partial.join(",\n"+gap)+"\n"+mind+"}":"{"+partial.join(",")+"}";gap=mind;return v}}if(typeof JSON.stringify!=="function"){JSON.stringify=function(value,replacer,space){var i;gap="";indent="";if(typeof space==="number"){for(i=0;i<space;i+=1){indent+=" "}}else{if(typeof space==="string"){indent=space}}rep=replacer;if(replacer&&typeof replacer!=="function"&&(typeof replacer!=="object"||typeof replacer.length!=="number")){throw new Error("JSON.stringify")}return str("",{"":value})}}if(typeof JSON.parse!=="function"){JSON.parse=function(text,reviver){var j;function walk(holder,key){var k,v,value=holder[key];if(value&&typeof value==="object"){for(k in value){if(Object.hasOwnProperty.call(value,k)){v=walk(value,k);if(v!==undefined){value[k]=v}else{delete value[k]}}}}return reviver.call(holder,key,value)}cx.lastIndex=0;if(cx.test(text)){text=text.replace(cx,function(a){return"\\u"+("0000"+a.charCodeAt(0).toString(16)).slice(-4)})}if(/^[\],:{}\s]*$/.test(text.replace(/\\(?:["\\\/bfnrt]|u[0-9a-fA-F]{4})/g,"@").replace(/"[^"\\\n\r]*"|true|false|null|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?/g,"]").replace(/(?:^|:|,)(?:\s*\[)+/g,""))){j=eval("("+text+")");return typeof reviver==="function"?walk({"":j},""):j}throw new SyntaxError("JSON.parse")}}}());(function(){if(typeof encodeURIComponent=="undefined"){return}function a(b){if(!b){return""}if(typeof b=="string"){return encodeURI(b)}var c=[];tddjs.each(b,function(e,d){c.push(encodeURIComponent(e)+"="+encodeURIComponent(d))});return c.join("&")}tddjs.namespace("util").urlParams=a}());(function(){var g;var d=tddjs.namespace("ajax");var b=[function(){return new ActiveXObject("Microsoft.XMLHTTP")},function(){return new XMLHttpRequest()}];for(var c=0,a=b.length;c<a;c++){try{g=b[c]();if(typeof g.readyState=="number"&&tddjs.isHostMethod(g,"open")&&tddjs.isHostMethod(g,"send")&&tddjs.isHostMethod(g,"setRequestHeader")){d.create=b[c]}}catch(f){}}}());tddjs.noop=function(){};(function(){var e=tddjs.namespace("ajax");if(!e.create){return}function a(k){var j=k.status;return(j>=200&&j<300)||j==304||(tddjs.isLocal()&&!j)}function h(j){var k=j.transport;if(a(k)){if(typeof j.success=="function"){j.success(k)}}else{if(typeof j.failure=="function"){j.failure(k)}}if(typeof j.complete=="function"){j.complete(k)}}function i(j){if(j.data){j.data=tddjs.util.urlParams(j.data);if(j.method=="GET"){var k=j.url.indexOf("?")>=0;j.url+=k?"&":"?";j.url+=j.data;j.data=null}}else{j.data=null}}function d(m,k,l,j){if(!k[l]){m.setRequestHeader(l,j)}}function g(j){var k=j.headers||{};var l=j.transport;tddjs.each(k,function(n,m){l.setRequestHeader(n,m)});if(j.method=="POST"&&j.data){d(l,k,"Content-Type","application/x-www-form-urlencoded");d(l,k,"Content-Length",j.data.length)}d(l,k,"X-Requested-With","XMLHttpRequest")}function c(k,j){if(typeof k!="string"){throw new TypeError("URL should be string")}j=tddjs.extend({},j);j.url=k;i(j);var l=tddjs.ajax.create();j.transport=l;l.open(j.method||"GET",j.url,true);g(j);l.onreadystatechange=function(){if(l.readyState==4){h(j);l.onreadystatechange=tddjs.noop}};l.send(j.data)}e.request=c;function b(k,j){j=tddjs.extend({},j);j.method="GET";e.request(k,j)}e.get=b;function f(k,j){j=tddjs.extend({},j);j.method="POST";e.request(k,j)}e.post=f}());(function(){if(typeof tddjs=="undefined"){return}var a=tddjs.namespace("ajax");if(!a.request||!Object.create){return}function c(){if(!this.url){throw new TypeError("Must specify URL to poll")}var g=this;var d=1000;var f=new Date().getTime();if(typeof this.interval=="number"){d=this.interval}var e=this.url.indexOf("?")<0?"?":"&";a.request(this.url+e+f,{complete:function(){var h=new Date().getTime()-f;var i=d-h;setTimeout(function(){g.start()},Math.max(0,i));if(typeof g.complete=="function"){g.complete()}},headers:g.headers,success:g.success,failure:g.failure})}a.poller={start:c};function b(e,d){var f=Object.create(a.poller);f.url=e;d=d||{};f.headers=d.headers;f.success=d.success;f.failure=d.failure;f.complete=d.complete;f.interval=d.interval;f.start();return f}a.poll=b}());(function(){if(typeof tddjs=="undefined"){return}var e=tddjs.namespace("ajax");var a=tddjs.namespace("util");if(!e.poll||!a.observable){return}function c(g){var h=this.observers;if(!h||typeof h.notify!="function"){return}tddjs.each(g,function(j,l){var m=l&&l.length;for(var k=0;k<m;k++){h.notify(j,l[k])}})}function f(h,g){if(!this.observers){this.observers=Object.create(a.observable)}this.observers.observe(h,g)}function b(){if(!this.url){throw new TypeError("client url is null")}var g={"Content-Type":"application/json","X-Access-Token":""};if(!this.poller){this.poller=e.poll(this.url,{success:function(j){try{var h=JSON.parse(j.responseText);g["X-Access-Token"]=h.token;this.dispatch(h)}catch(i){}}.bind(this),headers:g})}}function d(g,h){if(!this.url){throw new TypeError("url is null")}if(!h){throw new TypeError("data is null")}e.post(this.url,{data:JSON.stringify({topic:g,data:h})})}e.cometClient={dispatch:c,observe:f,notify:d,connect:b}}());(function(){if(typeof tddjs=="undefined"){return}var d=tddjs.dom;var a=tddjs.namespace("chat");if(!d||!d.addEventHandler||!Function.prototype.bind){return}function c(e){e.className="js-chat";var f=this.handleSubmit.bind(this);d.addEventHandler(e,"submit",f);this.view=e}function b(e){this.model=e}a.formController={setView:c,setModel:b}}());(function(){if(typeof tddjs=="undefined"||typeof document=="undefined"){return}var b=tddjs.util;var c=tddjs.namespace("chat");if(!b||!b.observable||!Object.create||!document.getElementsByTagName){return}function a(e){e.preventDefault();if(this.view){var d=this.view.getElementsByTagName("input")[0];var f=d.value;if(!f){return}this.view.className="";this.model.currentUser=f;this.notify("user",f)}}c.userFormController=tddjs.extend(Object.create(c.formController),b.observable);c.userFormController.handleSubmit=a}());(function(){if(typeof tddjs=="undefined"||typeof document=="undefined"){return}var b=tddjs.namespace("chat");if(!b.formController||!document.getElementsByTagName){return}function a(d){d.preventDefault();var c=this.view.getElementsByTagName("input")[0];if(!c.value){return}this.model.notify("message",{user:this.model.currentUser,message:c.value});c.value=""}b.messageFormController=Object.create(b.formController);b.messageFormController.handleSubmit=a}());(function(){if(typeof tddjs=="undefined"||typeof document=="undefined"||!document.createElement){return}var b=document.createElement("dl");if(!b.appendChild||typeof b.innerHTML!="string"){return}b=null;var a=tddjs.namespace("chat");function c(f){f.observe("message",this.addMessage.bind(this))}function e(g){if(this.prevUser!=g.user){var f=document.createElement("dt");f.innerHTML="@"+g.user;this.view.appendChild(f);this.prevUser=g.user;this.view.scrollTop=this.view.scrollHeight}var h=document.createElement("dd");h.innerHTML=g.message.replace(/</g,"&lt;").replace(/>/g,"&gt;");this.view.appendChild(h)}function d(f){f.className="js-chat";this.view=f}a.messageListController={setModel:c,setView:d,addMessage:e}}());(function(){if(typeof tddjs=="undefined"||typeof document=="undefined"){return}var e=tddjs.namespace("chat");if(!document.getElementById||!tddjs||!e.userFormController||!e.messageListController){alert("Browser is not supported");return}var b=Object.create(tddjs.ajax.cometClient);b.url="/comet";var d=document.getElementById("userForm");var a=Object.create(e.userFormController);a.setModel(b);a.setView(d);a.observe("user",function(c){var g=document.getElementById("messages");var i=Object.create(e.messageListController);i.setModel(b);i.setView(g);var h=document.getElementById("messageForm");var f=Object.create(e.messageFormController);f.setModel(b);f.setView(h);b.connect()})}());